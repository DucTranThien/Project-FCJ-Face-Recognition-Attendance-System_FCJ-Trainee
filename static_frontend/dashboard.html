<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - FCJ Face Check-in</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">

<style>
/* Essential Navbar Styles */
.navbar {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%) !important;
    backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding: 0.75rem 0;
}

.navbar-brand {
    text-decoration: none;
    transition: all 0.3s ease;
}

.brand-logo {
    height: 40px;
    width: auto;
    filter: brightness(1.1);
}

.brand-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: #ffffff;
    margin: 0;
    background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.brand-subtitle {
    font-size: 0.75rem;
    color: rgba(255,255,255,0.7);
    font-weight: 500;
    margin: 0;
    letter-spacing: 0.5px;
}

.navbar-nav .nav-link {
    color: rgba(255,255,255,0.8) !important;
    font-weight: 500;
    padding: 0.5rem 1rem !important;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.navbar-nav .nav-link:hover {
    color: #ffffff !important;
    background: rgba(255,255,255,0.1);
    transform: translateY(-1px);
}

/* Essential Footer Styles */
.footer-modern {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    color: #ffffff;
    border-top: 1px solid rgba(255,255,255,0.1);
    margin-top: 3rem;
    padding: 2rem 0;
}

.footer-logo {
    height: 32px;
    width: auto;
    filter: brightness(1.1);
}

.footer-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #ffffff;
    margin: 0;
}

.footer-subtitle {
    font-size: 0.8rem;
    color: rgba(255,255,255,0.7);
    margin: 0;
}

.footer-description {
    font-size: 0.85rem;
    color: rgba(255,255,255,0.8);
    line-height: 1.5;
    margin-top: 0.5rem;
}

.footer-heading {
    font-size: 0.9rem;
    font-weight: 600;
    color: #64b5f6;
    margin-bottom: 1rem;
}

.service-badge {
    background: rgba(100,181,246,0.2);
    color: #64b5f6;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
    border: 1px solid rgba(100,181,246,0.3);
    margin: 0.2rem;
    display: inline-block;
}

.footer-link {
    color: rgba(255,255,255,0.7);
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 500;
    margin: 0 0.5rem;
}

.footer-link:hover {
    color: #64b5f6;
}

.footer-copyright {
    color: rgba(255,255,255,0.6);
    font-size: 0.8rem;
}
</style>
</head>
<body>
<script>
// Check authentication on page load
(function() {
    const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
    if (!token) {
        window.location.href = 'login.html';
        return;
    }
    
    // Optional: Verify token with backend
    fetch('https://go18cmoqsa.execute-api.ap-southeast-1.amazonaws.com/default/verify-token', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
        }
    }).catch(() => {
        localStorage.removeItem('authToken');
        sessionStorage.removeItem('authToken');
        window.location.href = 'login.html';
    });
})();
</script>
    <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark sticky-top shadow-lg">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <div class="brand-logo-container me-3">
                    <img src="/static/images/fcj-logo.svg" alt="AWS FCJ Logo" class="brand-logo">
                </div>
                <div class="brand-text-container">
                    <div class="brand-title">FCJ Check-in</div>
                    <div class="brand-subtitle">AWS First Cloud Journey</div>
                </div>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="login.html">
                        <i class="bi bi-box-arrow-in-right me-1"></i>Login
                    </a>
                    <a class="nav-link" href="register.html">
                        <i class="bi bi-person-plus me-1"></i>Register
                    </a>
                    <a class="nav-link" href="dashboard.html">
                        <i class="bi bi-grid-3x3-gap me-1"></i>Dashboard
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <main>
        Dashboard - FCJ Face Check-in

<div class="container-fluid py-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3 col-md-4">
            <div class="card mb-4">
                <div class="card-body text-center">
                    <img src="" 
                         alt="" 
                         class="rounded-circle mb-3" 
                         style="width: 100px; height: 100px; object-fit: cover;"
                         onerror="this.onerror=null; this.src="/static/default-avatar.svg'">
                    <h5 class="mb-1"></h5>
                    <p class="text-muted mb-3">@</p>
                    <div class="d-grid gap-2">
                        <a href="checkin.html" class="btn btn-primary">
                            <i class="bi bi-camera"></i> Check-in
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Navigation Menu -->
            <div class="card">
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <a href="dashboard.html" class="list-group-item list-group-item-action active">
                            <i class="bi bi-speedometer2 me-2"></i> Dashboard
                        </a>
                        <a href="checkin.html" class="list-group-item list-group-item-action">
                            <i class="bi bi-camera me-2"></i> Check-in
                        </a>
                        <a href="profile.html" class="list-group-item list-group-item-action">
                            <i class="bi bi-person me-2"></i> Profile
                        </a>
                        <a href="history.html" class="list-group-item list-group-item-action">
                            <i class="bi bi-clock-history me-2"></i> History
                        </a>
                        <a href="leaderboard.html" class="list-group-item list-group-item-action">
                            <i class="bi bi-trophy me-2"></i> Leaderboard
                        </a>
                        <a href="#" class="list-group-item list-group-item-action text-danger">
                            <i class="bi bi-box-arrow-right me-2"></i> Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-lg-9 col-md-8">
            <!-- Welcome Header -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <h2 class="mb-1">, !</h2>
                            <p class="text-muted mb-0">
                                <i class="bi bi-calendar3"></i> 
                            </p>
                        </div>
                        <div class="col-auto">

                            <!-- if -->
                                <span class="badge bg-success fs-6">
                                    <i class="bi bi-check-circle"></i> Complete
                                </span>
                            
                                <span class="badge bg-warning fs-6">
                                    <i class="bi bi-clock"></i> Partial
                                </span>
                            <!-- else -->
                                <span class="badge bg-danger fs-6">
                                    <i class="bi bi-exclamation-triangle"></i> Pending
                                </span>
                            <!-- endif -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Summary Widgets -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>
                            <h3 class="mt-2 mb-1"></h3>
                            <p class="text-muted mb-0">Total Check-ins</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="bi bi-fire text-warning" style="font-size: 2rem;"></i>
                            <h3 class="mt-2 mb-1"></h3>
                            <p class="text-muted mb-0">Day Streak</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="bi bi-graph-up text-info" style="font-size: 2rem;"></i>
                            <h3 class="mt-2 mb-1">%</h3>
                            <p class="text-muted mb-0">Success Rate</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <!-- Today's Status -->
                <div class="col-lg-8">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-calendar-check"></i> Today's Sessions</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Morning Session -->
                                <div class="col-md-6">
                                    <div class="card border-<!-- if -->success<!-- else -->warning<!-- endif -->" id="morning-card">
                                        <div class="card-body text-center">
                                            <h6><i class="bi bi-sunrise"></i> Morning Check-in</h6>
                                            <p class="text-muted small">08:30 - 10:00 (Target: 09:00)</p>
                                            <div id="morning-status">
                                                <!-- if -->
                                                    <p class="mb-0">
                                                        <strong></strong><br>
                                                        <!-- if -->
                                                            <span class="badge bg-warning">
                                                                ⚠️ Completed Late
                                                            </span>
                                                        <!-- else -->
                                                            <span class="badge bg-success">
                                                                ✅ Completed On Time
                                                            </span>
                                                        <!-- endif --><br>
                                                        <small class="text-muted">Score: %</small>
                                                    </p>
                                                <!-- else -->
                                                    <p class="text-muted mb-2">❌ Not completed</p>
                                                    <a href="checkin.html" class="btn btn-sm btn-warning">Check-in</a>
                                                <!-- endif -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Evening Session -->
                                <div class="col-md-6">
                                    <div class="card border-<!-- if -->success<!-- else -->warning<!-- endif -->" id="evening-card">
                                        <div class="card-body text-center">
                                            <h6><i class="bi bi-sunset"></i> Evening Check-out</h6>
                                            <p class="text-muted small">16:30 - 18:00 (Target: 17:00)</p>
                                            <div id="evening-status">
                                                <!-- if -->
                                                    <p class="mb-0">
                                                        <strong></strong><br>
                                                        <!-- if -->
                                                            <span class="badge bg-warning">
                                                                ⚠️ Completed Late
                                                            </span>
                                                        <!-- else -->
                                                            <span class="badge bg-success">
                                                                ✅ Completed On Time
                                                            </span>
                                                        <!-- endif --><br>
                                                        <small class="text-muted">Score: %</small>
                                                    </p>
                                                <!-- else -->
                                                    <p class="text-muted mb-2">❌ Not completed</p>
                                                    <a href="checkin.html" class="btn btn-sm btn-warning">Check-out</a>
                                                <!-- endif -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Activity</h5>
                        </div>
                        <div class="card-body">
                            <!-- if -->
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Time</th>
                                                <th>Status</th>
                                                <th>Score</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            
                                        </tbody>
                                    </table>
                                </div>
                            <!-- else -->
                                <p class="text-muted text-center py-3">No recent check-ins found</p>
                            <!-- endif -->
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="col-lg-4">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-column gap-2">
                                <div id="smart-checkin-btn" class="d-grid">
                                    <a href="checkin.html" class="btn btn-primary btn-with-loading d-flex align-items-center justify-content-center" style="min-height: 42px;">
                                        <i class="bi bi-camera me-2"></i> Face Check-in
                                    </a>
                                </div>
                                <a href="edit_profile.html" class="btn btn-outline-secondary d-flex align-items-center justify-content-center" style="min-height: 42px;">
                                    <i class="bi bi-person me-2"></i> Edit Profile
                                </a>
                                <button class="btn btn-outline-info d-flex align-items-center justify-content-center" onclick="exportHistory()" style="min-height: 42px;">
                                    <i class="bi bi-download me-2"></i> Export History
                                </button>
                                <!-- if -->
                                <a href="admin_dashboard.html" class="btn btn-outline-warning d-flex align-items-center justify-content-center" style="min-height: 42px;">
                                    <i class="bi bi-shield-check me-2"></i> Admin Panel
                                </a>
                                <!-- endif -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Calendar -->
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0"><i class="bi bi-calendar3"></i> This Month</h5>
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshCalendar()">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                            <div id="motivational-quote" class="text-center">
                                <small class="text-primary fst-italic">"Consistency beats intensity. Check in and make it count!"</small>
                            </div>
                        </div>
                        <div class="card-body p-2">
                            <!-- Progress Bar -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="text-muted">Monthly Progress</small>
                                    <small class="text-muted" id="progress-text">0/31 days</small>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-success" id="progress-bar" style="width: 0%;"></div>
                                </div>
                            </div>
                            
                            <!-- Streak Tracker -->
                            <div class="text-center mb-3">
                                <span class="badge bg-warning" id="streak-badge">
                                    <i class="bi bi-fire"></i> 0 day streak
                                </span>
                            </div>
                            
                            <div id="calendar-container" class="calendar-grid">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            
                            <!-- Legend -->
                            <div class="mt-3 text-center">
                                <small class="text-muted d-block mb-2">Status Legend:</small>
                                <div class="d-flex justify-content-center gap-1 flex-wrap">
                                    <span class="badge bg-success"><i class="bi bi-check-circle"></i> Complete</span>
                                    <span class="badge bg-warning"><i class="bi bi-clock"></i> Partial</span>
                                    <span class="badge bg-danger"><i class="bi bi-exclamation-triangle"></i> Late</span>
                                    <span class="badge bg-light text-dark"><i class="bi bi-circle"></i> No Data</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Calendar Detail Modal -->
<div class="modal fade" id="calendarDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDate">Check-in Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-success mb-3" id="morningCard">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-sunrise"></i> Morning Check-in</h6>
                            </div>
                            <div class="card-body" id="morningDetails">
                                <p class="text-muted">No morning check-in recorded</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-warning mb-3" id="eveningCard">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-sunset"></i> Evening Check-out</h6>
                            </div>
                            <div class="card-body" id="eveningDetails">
                                <p class="text-muted">No evening check-out recorded</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3" id="dayMessage">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Complete both sessions for full attendance!
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="checkin.html" class="btn btn-primary">Check-in Now</a>
            </div>
        </div>
    </div>
</div>

<style>
.calendar-day {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
}
.calendar-day.success {
    background: #d1e7dd !important;
    border-color: #badbcc !important;
}
.calendar-day.missed {
    background: #f8d7da !important;
    border-color: #f5c2c7 !important;
}
.calendar-day.partial {
    background: #fff3cd !important;
    border-color: #ffecb5 !important;
}
.calendar-day.late {
    background: #f8d7da !important;
    border-color: #f5c2c7 !important;
    position: relative;
}
.calendar-day.late::after {
    content: '!';
    position: absolute;
    top: -2px;
    right: -2px;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 12px;
    height: 12px;
    font-size: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.calendar-day.today {
    box-shadow: 0 0 0 2px #0d6efd;
    animation: pulse 2s infinite;
}
.calendar-day:hover {
    cursor: pointer;
    transform: scale(1.1);
    transition: all 0.2s ease;
    z-index: 10;
    position: relative;
}
.calendar-grid {
    min-height: 200px;
}
@keyframes pulse {
    0% { box-shadow: 0 0 0 2px #0d6efd; }
    50% { box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.3); }
    100% { box-shadow: 0 0 0 2px #0d6efd; }
}
.btn-with-loading:disabled {
    position: relative;
}
.btn-with-loading:disabled::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    margin: auto;
    border: 2px solid transparent;
    border-top-color: #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
// Real-time dashboard functionality
class DashboardManager {
    constructor() {
        this.initializeRealTimeUpdates();
        this.loadCalendar();
    }
    
    async initializeRealTimeUpdates() {
        // Update status every 30 seconds
        setInterval(() => this.updateStatus(), 30000);
        
        // Initial load
        await this.updateStatus();
    }
    
    async updateStatus() {
        try {
            const response = await fetch('https://go18cmoqsa.execute-api.ap-southeast-1.amazonaws.com/default/api/checkin-status', {
                method: 'GET',
                credentials: 'include'
            });
            const data = await response.json();
            
            if (data.error) {
                console.log('Status API: User not authenticated');
                return;
            }
            
            // Update session status badges
            this.updateSessionBadges(data.today_sessions);
            
            // Update session cards
            this.updateSessionCards(data.today_sessions);
            
            // Update recent activity
            this.updateRecentActivity(data.recent_checkins);
            
            // Update smart check-in button
            this.updateSmartCheckinButton(data.today_sessions);
            
            // Refresh calendar to show latest data
            this.loadCalendar();
            
        } catch (error) {
            console.error('Failed to update status:', error);
        }
    }
    
    updateSessionCards(sessions) {
        // Update morning session card
        const morningCard = document.getElementById('morning-card');
        const morningStatus = document.getElementById('morning-status');
        
        if (morningCard && sessions.morning && sessions.morning.completed) {
            morningCard.className = 'card border-success';
            morningStatus.innerHTML = `
                <p class="mb-0">
                    <strong>${sessions.morning.time}</strong><br>
                    <span class="badge bg-success">
                        ✅ Completed
                    </span><br>
                    <small class="text-muted">Score: ${sessions.morning.similarity.toFixed(1)}%</small>
                </p>
            `;
        }
        
        // Update evening session card
        const eveningCard = document.getElementById('evening-card');
        const eveningStatus = document.getElementById('evening-status');
        
        if (eveningCard && sessions.evening && sessions.evening.completed) {
            eveningCard.className = 'card border-success';
            eveningStatus.innerHTML = `
                <p class="mb-0">
                    <strong>${sessions.evening.time}</strong><br>
                    <span class="badge bg-success">
                        ✅ Completed
                    </span><br>
                    <small class="text-muted">Score: ${sessions.evening.similarity.toFixed(1)}%</small>
                </p>
            `;
        }
    }
    
    updateSmartCheckinButton(sessions) {
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const currentTime = currentHour * 60 + currentMinute;
        
        const morningStart = 8 * 60 + 30; // 08:30
        const morningEnd = 10 * 60; // 10:00
        const eveningStart = 16 * 60 + 30; // 16:30
        const eveningEnd = 18 * 60; // 18:00
        
        const container = document.getElementById('smart-checkin-btn');
        if (!container) return;
        
        let buttonHtml = '';
        
        if (currentTime >= morningStart && currentTime <= morningEnd) {
            // Morning window
            if (sessions.morning && sessions.morning.completed) {
                buttonHtml = `
                    <button class="btn btn-success btn-with-loading d-flex align-items-center justify-content-center" disabled style="min-height: 42px;">
                        <i class="bi bi-check-circle me-2"></i> Morning Complete
                    </button>
                `;
            } else {
                buttonHtml = `
                    <a href="checkin" class="btn btn-primary btn-with-loading d-flex align-items-center justify-content-center" style="min-height: 42px;">
                        <i class="bi bi-sunrise me-2"></i> Morning Check-in
                    </a>
                `;
            }
        } else if (currentTime >= eveningStart && currentTime <= eveningEnd) {
            // Evening window
            if (sessions.evening && sessions.evening.completed) {
                buttonHtml = `
                    <button class="btn btn-success btn-with-loading d-flex align-items-center justify-content-center" disabled style="min-height: 42px;">
                        <i class="bi bi-check-circle me-2"></i> Evening Complete
                    </button>
                `;
            } else {
                buttonHtml = `
                    <a href="checkin" class="btn btn-warning btn-with-loading d-flex align-items-center justify-content-center" style="min-height: 42px;">
                        <i class="bi bi-sunset me-2"></i> Evening Check-out
                    </a>
                `;
            }
        } else {
            // Outside windows - will be marked as 'late'
            buttonHtml = `
                <a href="checkin" class="btn btn-outline-secondary btn-with-loading d-flex align-items-center justify-content-center" style="min-height: 42px;">
                    <i class="bi bi-camera me-2"></i> Late Check-in
                </a>
            `;
        }
        
        container.innerHTML = buttonHtml;
    }
    
    updateSessionBadges(sessions) {
        const morningComplete = sessions.morning.completed;
        const eveningComplete = sessions.evening.completed;
        
        const badge = document.querySelector('.badge.fs-6');
        if (!badge) return;
        
        if (morningComplete && eveningComplete) {
            badge.className = 'badge bg-success fs-6';
            badge.innerHTML = '<i class="bi bi-check-circle"></i> Complete';
        } else if (morningComplete || eveningComplete) {
            badge.className = 'badge bg-warning fs-6';
            badge.innerHTML = '<i class="bi bi-clock"></i> Partial';
        } else {
            badge.className = 'badge bg-danger fs-6';
            badge.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Pending';
        }
    }
    
    updateRecentActivity(checkins) {
        const tbody = document.querySelector('.table tbody');
        if (!tbody || !checkins.length) return;
        
        tbody.innerHTML = checkins.map(checkin => `
            <tr>
                <td>${checkin.checkin_time.substring(0, 10)}</td>
                <td>
                    ${checkin.checkin_time.substring(11, 19)}
                    ${checkin.check_type ? `<br><small class="text-muted">
                        <i class="bi bi-${checkin.check_type === 'morning' ? 'sunrise' : 'sunset'}"></i> ${checkin.check_type.charAt(0).toUpperCase() + checkin.check_type.slice(1)}
                    </small>` : ''}
                </td>
                <td>
                    <span class="badge bg-${checkin.status === 'success' ? 'success' : 'danger'}">
                        ${checkin.status.charAt(0).toUpperCase() + checkin.status.slice(1)}
                    </span>
                </td>
                <td>${parseFloat(checkin.similarity).toFixed(1)}%</td>
            </tr>
        `).join('');
    }
    
    async loadCalendar() {
        try {
            const response = await fetch('https://go18cmoqsa.execute-api.ap-southeast-1.amazonaws.com/default/api/calendar-data', {
                method: 'GET',
                credentials: 'include'
            });
            const data = await response.json();
            
            if (data.error) {
                console.error('Calendar API error:', data.error);
                return;
            }
            
            // Check if user is authenticated
            if (!data.authenticated) {
                console.log('User not authenticated, showing empty calendar');
                this.renderEmptyCalendar(data);
                return;
            }
            
            this.renderCalendar(data);
            
        } catch (error) {
            console.error('Failed to load calendar:', error);
            document.getElementById('calendar-container').innerHTML = '<p class="text-muted">Failed to load calendar</p>';
        }
    }
    
    async refreshCalendar() {
        console.log('🔄 Refreshing calendar data...');
        await this.loadCalendar();
        await this.updateStatus();
        console.log('✅ Calendar refreshed');
    }
    
    renderCalendar(data) {
        const container = document.getElementById('calendar-container');
        const { calendar, daily_sessions, daily_status } = data;
        const today = new Date();
        const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        
        let html = `
            <div class="row g-1 mb-2">
                <div class="col"><small class="text-muted fw-bold">S</small></div>
                <div class="col"><small class="text-muted fw-bold">M</small></div>
                <div class="col"><small class="text-muted fw-bold">T</small></div>
                <div class="col"><small class="text-muted fw-bold">W</small></div>
                <div class="col"><small class="text-muted fw-bold">T</small></div>
                <div class="col"><small class="text-muted fw-bold">F</small></div>
                <div class="col"><small class="text-muted fw-bold">S</small></div>
            </div>
        `;
        
        let completeDays = 0;
        let totalDays = 0;
        let currentStreak = 0;
        let streakDates = [];
        
        calendar.forEach(week => {
            html += '<div class="row g-1 mb-1">';
            week.forEach(day => {
                if (day === 0) {
                    html += '<div class="col"></div>';
                } else {
                    totalDays++;
                    const dateStr = `${data.year}-${String(data.month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const status = daily_status ? daily_status[dateStr] || 'No Data' : 'No Data';
                    const sessions = daily_sessions[dateStr];
                    const isToday = dateStr === todayStr;
                    
                    let className = 'calendar-day p-1 rounded text-center position-relative';
                    let statusIcon = '';
                    
                    // Apply styling based on status
                    switch(status) {
                        case 'Complete':
                            className += ' success';
                            statusIcon = '<i class="bi bi-check-circle-fill text-white" style="font-size: 10px;"></i>';
                            streakDates.push(dateStr);
                            break;
                        case 'Partial':
                            className += ' partial';
                            statusIcon = '<i class="bi bi-clock-fill text-white" style="font-size: 10px;"></i>';
                            break;
                        case 'Late':
                            className += ' late';
                            statusIcon = '<i class="bi bi-exclamation-triangle-fill text-white" style="font-size: 10px;"></i>';
                            break;
                        case 'No Data':
                        default:
                            className += ' bg-light text-muted';
                            statusIcon = '<i class="bi bi-circle text-muted" style="font-size: 8px;"></i>';
                            break;
                    }
                    
                    if (isToday) {
                        className += ' today';
                    }
                    
                    html += `
                        <div class="col">
                            <div class="${className}" 
                                 style="font-size: 0.75rem; height: 28px; line-height: 18px; cursor: pointer;" 
                                 onclick="showDayDetailsModal('${dateStr}', ${JSON.stringify(sessions || {}).replace(/"/g, '&quot;')})"
                                 data-bs-toggle="tooltip" 
                                 title="${dateStr}: ${status}">
                                <div>${day}</div>
                                <div style="position: absolute; bottom: 1px; right: 1px;">${statusIcon}</div>
                            </div>
                        </div>
                    `;
                }
            });
            html += '</div>';
        });
        
        container.innerHTML = html;

        // Calculate consecutive streak from today backwards
        const sortedDates = streakDates.sort().reverse();
        currentStreak = this.calculateConsecutiveStreak(sortedDates, todayStr);
        
        // Use monthly progress data if available
        if (data.monthly_progress) {
            this.updateProgress(data.monthly_progress.complete_days, data.monthly_progress.total_days);
        } else {
            // Fallback to calculated complete days
            const completeDaysCount = Object.values(daily_status).filter(status => status === 'Complete').length;
            this.updateProgress(completeDaysCount, totalDays);
        }
        
        this.updateStreak(currentStreak);
        this.updateMotivationalQuote();
        
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
    
    checkIfLate(sessions) {
        if (sessions.morning && sessions.morning.is_late) {
            return true;
        }
        if (sessions.evening && sessions.evening.is_late) {
            return true;
        }
        return false;
    }
    
    getSessionStatus(sessions) {
        const morningComplete = sessions.morning && sessions.morning.status === 'success';
        const eveningComplete = sessions.evening && sessions.evening.status === 'success';
        const hasLate = this.checkIfLate(sessions);
        
        if (morningComplete && eveningComplete) {
            return hasLate ? 'complete-late' : 'complete';
        } else if (morningComplete || eveningComplete) {
            return hasLate ? 'partial-late' : 'partial';
        }
        return 'none';
    }
    
    getTooltipText(dateStr, sessions) {
        if (!sessions || (!sessions.morning && !sessions.evening)) {
            return `${dateStr}: No check-in data`;
        }
        
        let text = `${dateStr}:\n`;
        if (sessions.morning) {
            text += `Morning: ${sessions.morning.time || 'Completed'}\n`;
        }
        if (sessions.evening) {
            text += `Evening: ${sessions.evening.time || 'Completed'}`;
        }
        return text;
    }
    
    updateProgress(complete, total) {
        const percentage = total > 0 ? Math.round((complete / total) * 100) : 0;
        document.getElementById('progress-bar').style.width = `${percentage}%`;
        document.getElementById('progress-text').textContent = `${complete}/${total} days (${percentage}%)`;
    }
    
    updateStreak(streak) {
        const badge = document.getElementById('streak-badge');
        badge.innerHTML = `<i class="bi bi-fire"></i> ${streak} day${streak !== 1 ? 's' : ''} streak`;
        
        if (streak >= 7) {
            badge.className = 'badge bg-success';
        } else if (streak >= 3) {
            badge.className = 'badge bg-warning';
        } else {
            badge.className = 'badge bg-secondary';
        }
    }
    
    calculateConsecutiveStreak(sortedDates, todayStr) {
        if (!sortedDates.length) return 0;
        
        let streak = 0;
        const today = new Date(todayStr);
        let checkDate = new Date(today);
        
        // Check backwards from today
        while (checkDate >= new Date(sortedDates[sortedDates.length - 1])) {
            const checkDateStr = checkDate.toISOString().split('T')[0];
            if (sortedDates.includes(checkDateStr)) {
                streak++;
                checkDate.setDate(checkDate.getDate() - 1);
            } else {
                break;
            }
        }
        
        return streak;
    }
    
    renderEmptyCalendar(data) {
        const container = document.getElementById('calendar-container');
        const { calendar } = data;
        const today = new Date();
        const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        
        let html = `
            <div class="row g-1 mb-2">
                <div class="col"><small class="text-muted fw-bold">S</small></div>
                <div class="col"><small class="text-muted fw-bold">M</small></div>
                <div class="col"><small class="text-muted fw-bold">T</small></div>
                <div class="col"><small class="text-muted fw-bold">W</small></div>
                <div class="col"><small class="text-muted fw-bold">T</small></div>
                <div class="col"><small class="text-muted fw-bold">F</small></div>
                <div class="col"><small class="text-muted fw-bold">S</small></div>
            </div>
        `;
        
        calendar.forEach(week => {
            html += '<div class="row g-1 mb-1">';
            week.forEach(day => {
                if (day === 0) {
                    html += '<div class="col"></div>';
                } else {
                    const dateStr = `${data.year}-${String(data.month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isToday = dateStr === todayStr;
                    
                    let className = 'calendar-day p-1 rounded text-center position-relative bg-light text-muted';
                    
                    if (isToday) {
                        className += ' border border-primary';
                    }
                    
                    html += `
                        <div class="col">
                            <div class="${className}" 
                                 style="font-size: 0.75rem; height: 28px; line-height: 18px;"
                                 title="Login to view check-in status">
                                <div>${day}</div>
                            </div>
                        </div>
                    `;
                }
            });
            html += '</div>';
        });
        
        container.innerHTML = html;
        
        // Update progress and streak to 0
        this.updateProgress(0, 0);
        this.updateStreak(0);
        
        // Show login message
        document.getElementById('motivational-quote').innerHTML = 
            '<small class="text-muted fst-italic">"Login to track your check-in progress!"</small>';
    }
    
    updateMotivationalQuote() {
        const quotes = [
            "Consistency beats intensity. Check in and make it count!",
            "Every check-in is a step towards your goals!",
            "Success is built one day at a time. Keep going!",
            "Your commitment today shapes your success tomorrow.",
            "Small daily improvements lead to stunning results.",
            "Excellence is not an act, but a habit. Keep checking in!",
            "Progress, not perfection. Every check-in matters."
        ];
        
        const today = new Date().getDate();
        const quote = quotes[today % quotes.length];
        document.getElementById('motivational-quote').innerHTML = 
            `<small class="text-primary fst-italic">"${quote}"</small>`;
    }
}

// Global functions
function refreshCalendar() {
    if (window.dashboardManager) {
        window.dashboardManager.refreshCalendar();
    }
}

// Global function for refreshing after check-in success
function refreshAfterCheckin() {
    console.log('🔄 Refreshing dashboard after check-in...');
    if (window.dashboardManager) {
        window.dashboardManager.refreshCalendar();
    }
    // Show success message
    if (window.notificationManager) {
        window.notificationManager.show('Calendar updated with latest check-in!', 'success');
    }
}

function exportHistory() {
    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Exporting...';
    
    window.location.href = '/export';
    
    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-download"></i> Export History';
        notificationManager.show('History exported successfully!', 'success');
    }, 2000);
}

function showDayDetailsModal(date, sessions) {
    // Update modal title
    document.getElementById('modalDate').textContent = `Check-in Details - ${date}`;
    
    // Update morning card
    const morningCard = document.getElementById('morningCard');
    const morningDetails = document.getElementById('morningDetails');
    
    if (sessions.morning) {
        morningCard.className = 'card border-success mb-3';
        morningDetails.innerHTML = `
            <div class="d-flex align-items-center mb-2">
                <i class="bi bi-check-circle-fill text-success me-2"></i>
                <strong>Completed (${sessions.morning.check_type || 'morning'})</strong>
            </div>
            <p class="mb-1"><strong>Time:</strong> ${sessions.morning.time || 'N/A'}</p>
            <p class="mb-1"><strong>Type:</strong> <span class="badge bg-primary">${sessions.morning.check_type || 'morning'}</span></p>
            ${sessions.morning.similarity ? `<p class="mb-0"><strong>Similarity:</strong> ${sessions.morning.similarity}%</p>` : ''}
        `;
    } else {
        morningCard.className = 'card border-light mb-3';
        morningDetails.innerHTML = `
            <div class="d-flex align-items-center mb-2">
                <i class="bi bi-x-circle text-muted me-2"></i>
                <span class="text-muted">Not completed</span>
            </div>
            <p class="text-muted mb-0">Target time: 08:30 - 10:00</p>
        `;
    }
    
    // Update evening card
    const eveningCard = document.getElementById('eveningCard');
    const eveningDetails = document.getElementById('eveningDetails');
    
    if (sessions.evening) {
        eveningCard.className = 'card border-success mb-3';
        eveningDetails.innerHTML = `
            <div class="d-flex align-items-center mb-2">
                <i class="bi bi-check-circle-fill text-success me-2"></i>
                <strong>Completed (${sessions.evening.check_type || 'evening'})</strong>
            </div>
            <p class="mb-1"><strong>Time:</strong> ${sessions.evening.time || 'N/A'}</p>
            <p class="mb-1"><strong>Type:</strong> <span class="badge bg-primary">${sessions.evening.check_type || 'evening'}</span></p>
            ${sessions.evening.similarity ? `<p class="mb-0"><strong>Similarity:</strong> ${sessions.evening.similarity}%</p>` : ''}
        `;
    } else {
        eveningCard.className = 'card border-light mb-3';
        eveningDetails.innerHTML = `
            <div class="d-flex align-items-center mb-2">
                <i class="bi bi-x-circle text-muted me-2"></i>
                <span class="text-muted">Not completed</span>
            </div>
            <p class="text-muted mb-0">Target time: 16:30 - 18:00</p>
        `;
    }
    
    // Update day message based on check_type
    const dayMessage = document.getElementById('dayMessage');
    const morningDone = sessions.morning;
    const eveningDone = sessions.evening;
    
    if (morningDone && eveningDone) {
        dayMessage.innerHTML = `
            <div class="alert alert-success">
                <i class="bi bi-check-circle-fill"></i> Perfect attendance! Both sessions completed.
            </div>
        `;
    } else if (morningDone || eveningDone) {
        dayMessage.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> Partial attendance. Complete both sessions for full credit.
            </div>
        `;
    } else {
        dayMessage.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No check-ins recorded for this date.
            </div>
        `;
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('calendarDetailModal'));
    modal.show();
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    window.dashboardManager = new DashboardManager();
    
    // Check if returning from check-in and force refresh
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('refresh') === '1') {
        // Remove refresh parameter from URL
        window.history.replaceState({}, document.title, window.location.pathname);
        
        // Force immediate status update
        setTimeout(() => {
            window.dashboardManager.updateStatus();
            if (window.notificationManager) {
                window.notificationManager.show('Dashboard updated with latest check-in data', 'info', 3000);
            }
        }, 500);
    }
});
</script>
    </main>

    <!-- Footer -->
    <footer class="footer-modern mt-auto">
        <div class="container">
            <div class="row align-items-center py-4">
                <div class="col-lg-4 col-md-6 mb-3 mb-md-0">
                    <div class="footer-brand">
                        <div class="d-flex align-items-center mb-2">
                            <img src="/static/images/fcj-logo.svg" alt="AWS FCJ Logo" class="footer-logo me-2">
                            <div>
                                <div class="footer-title">FCJ Check-in</div>
                                <div class="footer-subtitle">Enterprise Attendance System</div>
                            </div>
                        </div>
                        <p class="footer-description mb-0">
                            Secure, AI-powered attendance management built on AWS cloud infrastructure.
                        </p>
                    </div>
                </div>
                
                <div class="col-lg-4 col-md-6 mb-3 mb-md-0">
                    <div class="footer-section">
                        <h6 class="footer-heading">
                            <i class="bi bi-cloud-check me-2"></i>Powered by FCJ Trainee Tran Thien Duc 
                        </h6>
                        <div class="aws-services">
                            <span class="service-badge"><i class="bi bi-eye"></i> Rekognition</span>
                            <span class="service-badge"><i class="bi bi-database"></i> DynamoDB</span>
                            <span class="service-badge"><i class="bi bi-cloud-upload"></i> S3</span>
                            <span class="service-badge"><i class="bi bi-envelope"></i> SES</span>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4 col-12">
                    <div class="footer-section text-lg-end">
                        <div class="footer-links mb-2">
                            <a href="#" class="footer-link">Privacy Policy</a>
                            <a href="#" class="footer-link">Terms of Service</a>
                            <a href="#" class="footer-link">Support</a>
                        </div>
                        <div class="footer-copyright">
                            <small>© 2025 FCJ Trainees. Built with ❤️ on AWS.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/notifications.js"></script>
    <script src="/static/js/main.js"></script>
</body>
</html>